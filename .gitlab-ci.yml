stages:
  - fetch_repos

variables:
  GITLAB_ACCESS_TOKEN: $ACCESS_TOKEN  # Ensure this is defined in your GitLab CI/CD settings
  GITLAB_GROUP_ID: "your_group_id"    # Ensure this is set to your target GitLab group ID

fetch_repo_details:
  stage: fetch_repos
  image: alpine:latest  # Alpine is lightweight and includes essential tools
  before_script:
    - apk update && apk add jq curl  # Install jq and curl if not present
  script:
    - |
      BASE_URL="https://sfgitlab.opr.statefarm.org/api/v4"
      PAGE=1
      PER_PAGE=100
      OUTPUT_FILE="all_projects.json"
      echo "[]" > $OUTPUT_FILE  # Initialize a JSON file to store project details

      fetch_projects() {
        local page=$1
        curl -s --header "PRIVATE-TOKEN: ${GITLAB_ACCESS_TOKEN}" \
          "${BASE_URL}/groups/${GITLAB_GROUP_ID}/projects?include_subgroups=true&per_page=${PER_PAGE}&page=${page}"
      }

      process_project() {
        local project=$1
        local project_id=$(echo $project | jq -r '.id')
        local project_name=$(echo $project | jq -r '.name' | sed 's/\"/\\\"/g')
        
        fetch_branches $project_id | jq -c '.[]' | while read branch; do
          local branch_name=$(echo $branch | jq -r '.name' | sed 's/\"/\\\"/g')
          local is_protected=$(echo $branch | jq -r '.protected')
          
          if [[ "$branch_name" == "master" || "$branch_name" == "main" ]]; then
            local new_entry="{\"project_name\": \"$project_name\", \"branch_name\": \"$branch_name\", \"protected\": $is_protected}"
            echo $(jq ". + [$new_entry]" $OUTPUT_FILE) > $OUTPUT_FILE
          fi
        done
      }

      fetch_branches() {
        local project_id=$1
        curl -s --header "PRIVATE-TOKEN: ${GITLAB_ACCESS_TOKEN}" \
          "${BASE_URL}/projects/${project_id}/repository/branches"
      }

      while :; do
        PROJECTS_JSON=$(fetch_projects $PAGE)
        
        if [ -z "$(echo $PROJECTS_JSON | jq '.[]')" ]; then
          break
        fi

        echo $PROJECTS_JSON | jq -c '.[]' | while read project; do
          process_project "$project"
        done

        ((PAGE++))
      done

  artifacts:
    paths:
      - all_projects.json  # Preserve the JSON file as a build artifact
    expire_in: 1 week
  only:
    - master  # Adjust to your branch strategy as needed









    stages:
  - fetch_repos

variables:
  GITLAB_ACCESS_TOKEN: $ACCESS_TOKEN  # Ensure this is defined in your GitLab CI/CD settings
  GITLAB_GROUP_ID: "your_group_id"    # Ensure this is set to your target GitLab group ID

fetch_repo_details:
  stage: fetch_repos
  image: alpine:latest  # Alpine is lightweight and includes essential tools
  before_script:
    - apk update && apk add jq curl  # Install jq and curl if not present
  script:
    - |
      BASE_URL="https://sfgitlab.opr.statefarm.org/api/v4"
      OUTPUT_FILE="all_projects.json"
      echo "[]" > $OUTPUT_FILE  # Initialize a JSON file to store project details

      fetch_projects() {
        local group_id=$1
        local page=$2
        curl -s --header "PRIVATE-TOKEN: ${GITLAB_ACCESS_TOKEN}" \
          "${BASE_URL}/groups/${group_id}/projects?include_subgroups=true&per_page=100&page=${page}"
      }

      fetch_subgroups() {
        local group_id=$1
        curl -s --header "PRIVATE-TOKEN: ${GITLAB_ACCESS_TOKEN}" \
          "${BASE_URL}/groups/${group_id}/subgroups"
      }

      process_project() {
        local project=$1
        local project_id=$(echo $project | jq -r '.id')
        local project_name=$(echo $project | jq -r '.name' | sed 's/\"/\\\"/g')

        fetch_branches $project_id | jq -c '.[]' | while read branch; do
          local branch_name=$(echo $branch | jq -r '.name' | sed 's/\"/\\\"/g')
          local is_protected=$(echo $branch | jq -r '.protected')

          if [[ "$branch_name" == "master" || "$branch_name" == "main" ]]; then
            local new_entry="{\"project_name\": \"$project_name\", \"branch_name\": \"$branch_name\", \"protected\": $is_protected}"
            echo $(jq ". + [$new_entry]" $OUTPUT_FILE) > $OUTPUT_FILE
          fi
        done
      }

      fetch_branches() {
        local project_id=$1
        curl -s --header "PRIVATE-TOKEN: ${GITLAB_ACCESS_TOKEN}" \
          "${BASE_URL}/projects/${project_id}/repository/branches"
      }

      process_group() {
        local group_id=$1
        local page=1

        while :; do
          PROJECTS_JSON=$(fetch_projects $group_id $page)

          if [ -z "$(echo $PROJECTS_JSON | jq '.[]')" ]; then
            break
          fi

          echo $PROJECTS_JSON | jq -c '.[]' | while read project; do
            process_project "$project"
          done

          ((page++))
        done

        SUBGROUPS_JSON=$(fetch_subgroups $group_id)
        echo $SUBGROUPS_JSON | jq -c '.[]' | while read subgroup; do
          local subgroup_id=$(echo $subgroup | jq -r '.id')
          process_group $subgroup_id
        done
      }

      process_group $GITLAB_GROUP_ID

  artifacts:
    paths:
      - all_projects.json  # Preserve the JSON file as a build artifact
    expire_in: 1 week
  only:
    - master  # Adjust to your branch strategy as needed

